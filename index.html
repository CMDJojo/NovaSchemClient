<!DOCTYPE html>
<head>
  <title id="title">Schema/Länkar</title>
  <link href="pstylesheet.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet">

  <link rel="icon" type="image/png" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAYAAACqaXHeAAAC8klEQVR42u2a7XGDMAyGyVD9lW3af52hi2WGzpARuIxAj/Tck4Uk68M2NJg7XQOBKn6iV5YVT9M0LSe3aTnrMQBQAErn6OHMqPcKzsX7WvsIAdAAsjxjud/yJZkiIL3m/g4A/xCAQmIjApo4GQDODKDWNFjDxyiENABOvxa43W5qu16vpvuP/MwAcHQA9/v9aZfHu8peDoB24N0BpG/ma/lQ2eEBpAFpjtWJduA1AKyfD/5NlrJ4FQCWYw8A2PD13QGs/0M6zxParLKuEsBlowQlAdAUGRCAduAeAAluGIDUgopKwAMgNHV+PjL7fls21jUHrIP61et2sOk6fB8O5nG5qOzpBw28GgAYZlDnONxLAPLkRV9LALQDDwOwhhmXA/D1qAS8AJ4gWwOonQOwPBKA9TocJD7nAPxFFACQru0GgJ7T5034YwDJ8DmG4ZaApbS1AIB54ygSICOgT1VXDnuNBLQAMARRAjibS5VdBEBJAtQsQIU8Ff4hCUhZnQLgK2v7SkCKgBQFJglE9ay9F/rpVgckp5r6XqrqOE3DqNE2KzkJcOFvAYA+i62LSukZAqAgrM94/HgiwAp6sv4+7w1niw8rAOzH3Ba3fjOecO7pxwLaBeCVnlEDiIbz0fxkACzr7mg4W9pbrSJgMwtYM61v5rD392KgZ9UKtCmAvHjKW9u4pR0B4C3SMgAQRGnNbfkdIbXRuBY3B6LmoksNQFN1rU6sh1cCPtDbilTqRbok0BIADGefn1mItIoALFtmpHY1ZxEAYQloAcAyWvo9QVqklABYNlRhAFLDpb8EiFYV1bqiAEiwtRKgFmtqAPAeLQD44bhuLdW93V0C0mtOAqVd3BEJaLe8cRKQZLC7BLj2VQsJmGcBqeuiPbIKDYV8SQaHkADXeXVVaEEJNAdgkUAEAPymudeUBDR5QAsgvBr0AiB1yeQBLgdIecC9QaJnBLSWQDMA3m0oVgDRtcBLbZQcABzT7dgsPQAMAAOAGcCZ7QcX9TmTBXbVYgAAAABJRU5ErkJggg==">
</head>

<body>
  <ul id=topbar>
      <li>
        <p id="time">JAVASCRIPT LOADING ERROR</p>
	    </li><li>
        <button onclick="weekIncrease(-1)" class="sb cl">←</button><input size="1" id="weekbox" class="inputbox" value="ERR"></input><button onclick="weekIncrease(1)" class="sb cr">→</button>
		</li><li>
        <button class="sb ca" id="smartButton" onclick="init()">JAVASCRIPT ERROR - CHECK SIDEBAR</button>
		</li><li>
        <button class="sb ca"><a href="" id="dllink" download="download.png">Ladda ned</a></button>
		</li>
  </ul>
  </div>

  <div id="linksdiv">
  <ul id="links">
  	<li>Det uppstod ett fel</li>
    <li>när denna sidan laddades.</li>
  	<li>Kontrollera att Javascript</li>
    <li>är aktiverat.</li>
    <li>Annars kan du</li>
    <li>kolla i konsolen, eller</li>
  	<a href="https://github.com/cmdjojo" target="_blank"><li>kontakta mig här!</li></a>
  </ul>
  </div>


  <canvas id="myCanvas"></canvas>
  <script>
    var setup = {
      "SchoolId":"82710Y",    //NOVASOFTWARE SCHOOLID
      "GroupId":"NA17D"       //NOVASOFTWARE GROUPID
    }
    var links = {
      "Hulebäcksgymnasiet":"http://hule.harryda.se/",
      "HuleDu":"http://huledu.harryda.se/",
      "Skolmaten":"http://skolmaten.se/hulebacksgymnasiet/",
      "Office Online":"https://office.com/",
      "Google Drive":"https://drive.google.com/drive/my-drive",
      "Nationalencyklopedin":"http://www.ne.se/"
    }
    var SchoolId, GroupId, Width, Height, week, currentURL
    function getSize(cut){
      if(cut===true){
        return {width:window.innerWidth-widthSpacing+canvasWidthDiff,height:window.innerHeight-heightSpacing+canvasHeightDiff}
      }else{
        return {width:window.innerWidth-widthSpacing,height:window.innerHeight-heightSpacing}
      }
    }
    function init(){
      widthSpacing = 293
      heightSpacing = 20
      canvasWidthDiff = -7
      canvasHeightDiff = -50
      drawOffsetX = -1
      drawOffsetY = -1
      SchoolId = setup.SchoolId
      GroupId = setup.GroupId
      Width = getSize(false).width
      Height = getSize(false).height
      dlWidth = 2480
      dlHeight = Math.floor(dlWidth*1.41)
      week = currentWeek()
      setWeek(week)
      updateTime()
      setInterval(updateTime,1000)
      smartBtnUpdate()
      setInterval(smartBtnUpdate,500)
      var innerHTMLList = ""
      Object.keys(links).forEach(function(value){
        innerHTMLList += '<a href='+links[value]+' target="_blank"><li>'+value+'</li></a>'
      })
      innerHTMLList += '<ul id="bottom"><li id="nobutton">Klient av Jonathan Widén och<br>Kalle Hernqvist Larsson</li></ul>'
      document.getElementById("links").innerHTML = innerHTMLList
    }
    function updateTime(){
      var newDate = new Date()
      var newDateArray = [newDate.getFullYear(),("0" + (newDate.getMonth()+1)).slice(-2),("0" + (newDate.getDate())).slice(-2),("0" + (newDate.getHours())).slice(-2),("0" + (newDate.getMinutes())).slice(-2)]
      document.getElementById("time").innerHTML = newDateArray[0]+"-"+newDateArray[1]+"-"+newDateArray[2]+" "+newDateArray[3]+":"+newDateArray[4]
    }
    function smartBtnUpdate(){
      document.body.style.height = window.innerHeight+"px"
      var boxWeek = document.getElementById("weekbox").value
      if(week==boxWeek){
        if(Width != getSize(false).width || Height != getSize(false).height){
          updateSize()
        }else if(currentWeek()==week){
          document.getElementById("smartButton").setAttribute("onclick","")
          document.getElementById("smartButton").innerHTML = "Detta är den nuvarande veckan"
        }else{
          document.getElementById("smartButton").setAttribute("onclick","setWeek(currentWeek())")
          document.getElementById("smartButton").innerHTML = "Gå till nuvarande veckan ("+currentWeek()+")"
        }
      }else{
        var regex = /(^0?\d$)|(^[1-4][0-9]$)|(^5[0-3]$)/g
        if(boxWeek.match(regex).length != 1){
          document.getElementById("smartButton").setAttribute("onclick","")
          document.getElementById("smartButton").innerHTML = boxWeek+" är inte en vecka"
        }else{
          document.getElementById("smartButton").setAttribute("onclick","setWeek(document.getElementById('weekbox').value)")
          document.getElementById("smartButton").innerHTML = "Gå till vecka "+boxWeek
        }
      }
    }
    function setWeek(value){
      if(isNaN(value)) value = week+1
      week = parseInt(value)
      printImage(makeUrl(week))
    }
    function updateSize(){
      Width = getSize(false).width
      Height = getSize(false).height
      printImage(makeUrl(week))
    }
    function currentWeek(){
      var d = new Date();
      var dayNum = d.getUTCDay() || 7;
      d.setUTCDate(d.getUTCDate() + 4 - dayNum);
      var yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
      return Math.ceil((((d - yearStart) / 86400000) + 1)/7)
    }
    function makeUrl(week,bigSize){
      if(bigSize===true){
        return "http://www.novasoftware.se/ImgGen/schedulegenerator.aspx?format=png&schoolid="+SchoolId+"/sv-se&type=-1&id="+GroupId+"&period=&week="+week+"&mode=0&printer=1&colors=32&head=0&clock=0&foot=0&day=0&width="+dlWidth+"&height="+dlHeight+"&maxwidth="+dlWidth+"&maxheight="+dlHeight
      }else{
        return "http://www.novasoftware.se/ImgGen/schedulegenerator.aspx?format=png&schoolid="+SchoolId+"/sv-se&type=-1&id="+GroupId+"&period=&week="+week+"&mode=0&printer=0&colors=32&head=0&clock=0&foot=0&day=0&width="+Width+"&height="+Height+"&maxwidth="+Width+"&maxheight="+Height
      }
    }
    function weekIncrease(no){
      week += no
      printImage(makeUrl(week))
    }
    function printImage(url){
      var c = document.getElementById("myCanvas");
      c.width = getSize(true).width
      c.height = getSize(true).height
      var ctx = c.getContext("2d");
      var img = new Image();
      currentURL = url
      img.onload = function() {
        if(img.src == currentURL) ctx.drawImage(img, drawOffsetX, drawOffsetY);
      };
      img.src = url
      document.getElementById("weekbox").value = week
      document.getElementById("dllink").href = makeUrl(week,true)
      var newDate = new Date()
      smartBtnUpdate()
      document.getElementById("title").innerHTML = GroupId+" v."+week
    }
    init()
  </script>
</body>
